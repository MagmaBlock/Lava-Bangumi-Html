<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>熔岩番剧库 - Loading | LavaAnime</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.staticfile.org/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <script src="https://cdn.staticfile.org/bootstrap/5.1.3/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <link href="./style/scrollbar.css" rel="stylesheet" crossorigin="anonymous">
    </link>

    <script>
        $(document).ready(function () {



            // 熔岩云盘分享链接根目录，需要是API链接。
            animeApiUrl = "https://dav.5t5.top/api/v3/share/list/jqMFl"


            console.log("从地址栏取回链接：", decodeURI(getUrlParams("path").path))
            AnimePath = getUrlParams("path").path

            // 填充副标题
            $("#la-path").empty().append(decodeURI(AnimePath).replace("/", ""))

            if (AnimePath == undefined) {
                console.log("地址栏不含参数！")
                $("#la-list-container").append("<div class='alert alert-warning'><span>错误：未能从地址栏取得番组信息。<a class='alert-link' href='/list.html'>返回主页</a></span></div>")
            }

            thisId = decodeURI(getUrlParams("path").path).match("\\d+$")[0]
            thisId2 = thisId.toString()
            thisId2 = thisId2.substring(0, thisId2.length - 2)

            console.log("从地址栏取得 BgmID： ", thisId  ," " , thisId2)


            // 获取字典并开始生成列表
            $.ajax({
                url: "./assets/dict.json",
                success: (result) => {
                    dict = result
                    getAnimeList(dict)
                    console.log("成功取得关键词词典：",dict)
                }
            })



            // 从网盘取得文件列表
            function getAnimeList() {
                $.ajax({
                    url: animeApiUrl + AnimePath,
                    success: function (result) {
                        console.log("熔岩云盘回复：", result)
                        // 剥壳
                        if (result.code == 404) {
                            $("#la-list-container").append("<div class='alert alert-warning'><span>熔岩云盘返回了 404，您的链接可能有误或番组不存在。<br>出现此错误可能是因为此界面的链接异常。<a class='alert-link' href='/list.html'>返回主页</a></span></div>")
                            $("#loading").fadeOut()

                        }
                        objects = result.data.objects
                        if (objects.length == 0) {
                            var airDate = "(获取失败，可能是 ID 设置有误，请联系 Magma。)"
                            setTimeout(() => {
                                airDate = bgmInfo.air_date
                                $("#la-list-container").append("<div class='alert alert-info'><span>熔岩云盘返回列表为空，此番组目录下尚无任何资源！<br>" + "请确认此作品已经开始连载，根据 Bangumi Wiki，本作的开始放送日期为：" + bgmInfo.air_date + "<br><a class='alert-link' href='/list.html'>返回主页</a></span></div>")
                                $("#loading").fadeOut()
                            }, 1500);

                        }
                        if (objects.length > 0) {
                            // 用自定义排序函数用 name 排序
                            mySort(objects, "name")
                            console.log(objects)
                            // 开始循环
                            for (var i = 0; i < objects.length; i++) {
                                // 如果这个数组描述的是一个文件类型的
                                if (objects[i].type == "file") {
                                    var fileName = objects[i].name
                                    var fileId = objects[i].id
                                    printAnimeList(fileName, fileId)
                                    // 1秒后隐藏loading
                                    setTimeout(() => {
                                        $("#loading").fadeOut()
                                    }, 1000);
                                }
                            }
                        }

                    },
                    error: (result) => {
                        $("#la-list-container").append("<div class='alert alert-warning'><span>熔岩云盘未返回值或返回错误，您的链接可能有误或熔岩云盘出现异常。<br><a class='alert-link' href='/list.html'>返回主页</a></span></div>")
                    }
                })
            }



            // 向列表追加生成的列表的函数
            function printAnimeList(fileName, fileId) {
                // 取得文件后缀名
                var fileType = fileName.replace(/.+\./, "")

                // 从字典将匹配的关键字替换为可视化标签
                tagedName = fileName
                for (i = 0; i < dict.length; i++) {
                    // 新建一个正则变量
                    fromRegExp = new RegExp(dict[i].from, 'gi')
                    // 生成的标签的html
                    toHtml = ' <span class="badge ' + dict[i].class + '">' + dict[i].to + '</span> '
                    // 进行替换
                    tagedName = tagedName.replace(fromRegExp, toHtml)
                }
                // 标签替换完成后，再空格所有的 '[' ']'
                tagedName = tagedName.replace(/\[|\]/g, " ")

                // 生成新的html
                var newListObj = "<button id='" + fileId + "' type='button' data-bs-toggle='modal' data-bs-target='#la-player' class='la-list-anime list-group-item list-group-item-action'>" + tagedName + '<br><span class="text-secondary fw-lighter" style="font-size: 12px">' + fileName + "</span></button>"
                // 追加html
                $("#la-list-container").append(newListObj)
                // 再给每个列表项增加点击时事件
                $("#" + fileId).click(function () {
                    // 加载中提示
                    $("#la-player-header").empty().append("正在等待熔岩云盘返回播放链接...")
                    $("#la-player-body").empty().append("<p>请稍等，这段文字通常活不过 1 秒...<br>但是若持续看到此提示可能是熔岩云盘出现异常或您的网络连接不稳定！</p>")
                    // 生成当前文件的变量
                    thisName = $(this)[0].innerText
                    thisId = $(this)[0].id
                    $.ajax({
                        url: "https://api.5t5.top/api/v1/object/url/" + thisId,
                        success: function (result) {
                            console.log(fileType)
                            // if (fileType = 'jpg' || 'png' || 'webp') {
                            //     $("#la-img-view").empty().append('<img class="img-fluid " src="' + result.url + '">')
                            //     $("#dplayer").empty()
                            // }
                            const dp = new DPlayer({
                                container: document.getElementById('dplayer'),
                                video: {
                                    url: result.url,
                                    screenshot: true
                                },
                            });


                            // 为播放器增加关闭时销毁事件
                            var lavaAnimeModalPlayer = document.getElementById('la-player')
                            lavaAnimeModalPlayer.addEventListener('hide.bs.modal', function (event) {
                                dp.destroy()
                                $("#la-img-view").empty()
                            })

                            var helpMessage = "<p class='mb-0'>主流浏览器仅支持播放 H.264 (通常为 MP4 格式) 的视频！<p class='text-secondary' style='font-size: 14px'>其他格式的视频可能会出现黑屏、无法加载字幕等情况，请使用下方的按钮。</p></p>"
                            var potplayerBtn = "<a class='btn btn-primary mb-2' href='potplayer://" + result.url + "'>点此调用 Windows 上的 PotPlayer 播放</a>"
                            var vlcBtn = "<a class='btn btn-primary mb-2' href='vlc://" + result.url + "'>点此调用移动设备上的 VLC 播放</a>"
                            var iinaBtn = '<a class="btn btn-primary mb-2" href="iina://weblink?url=' + result.url + '">点此调用 Mac IINA 播放 (Test)</a>'
                            var rawBtn = "<a class='btn btn-outline-primary mb-2' target='__blank' href='" + result.url + "s'>点此下载，长按或右键此处复制链接</a>"
                            $("#la-player-body").empty().append(helpMessage + potplayerBtn + "<br>" + vlcBtn + "<br>" + iinaBtn + "<br>" + rawBtn)
                            $("#la-player-header").empty().append(thisName)
                        }
                    })

                })
            }

            $.ajax({
                url: "https://api.bgm.tv/subject/" + thisId,
                success: result => {
                    bgmInfo = result
                    console.log('成功从番组计划API取得数据',result)
                }
            })




            //根据数组子项排序函数, 给出数组和排序的子项，原数组会被自动排序。代码来自网络
            function mySort(list, field) {
                var str = list[0][field]
                var pattern = new RegExp("[\u4E00-\u9FA5]+");
                var pattern2 = new RegExp("[A-Za-z]+");
                //验证是否是中文
                if (pattern.test(str) || pattern2.test(str)) {
                    list.sort(function (item1, item2) {
                        return item1[field].localeCompare(item2[field], "zh-CN");
                    });
                }
                //验证是否是数字
                var pattern3 = new RegExp("[0-9]+");
                if (pattern3.test(str)) {
                    list.sort(function (a, b) {
                        var value1 = a[field];
                        var value2 = b[field];
                        return value1 - value2;
                    });
                }
            }

            // 网页参数匹配函数。代码来自网络
            function getUrlParams() {
                let obj = {};

                if (!window) {
                    return;
                }

                let str = window.location.search || '';

                if (str && str.slice(1)) {
                    // 去掉 ？ ，然后以 & 分割
                    let queryArray = str.slice(1).split('&');
                    queryArray.map((query) => {
                        // param=value 以 = 分割
                        let temp = query.split('=');
                        if (temp.length > 1) {
                            // 收集参数
                            obj[temp[0]] = temp[1];
                        }
                    })
                }

                return obj;
            }
        })
    </script>
</head>

<body>
    <nav class="navbar navbar-light bg-light shadow fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/index.html">
                <img src="https://s-sh-2164-assets.oss.dogecdn.com/LavaDrive/icons/LavaCloud.svg" alt="" width="30"
                    height="30" class="d-inline-block align-bottom">
                熔岩番剧库 LavaAnime
            </a>
            <div id="loading" class="spinner-border text-secondary"></div>
        </div>
    </nav>
    <div class="container mt-5">


        <br>
        <!-- 
        <div class="card mb-3" style="max-width: 540px;">
            <div class="row g-0">
                <div style="max-height: 300px;" id="la-poster" class="col-md-4">
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <h5 class="card-title">Card title</h5>
                        <p class="card-text">This is a wider card with supporting text below as a natural lead-in to
                            additional content. This content is a little bit longer.</p>
                        <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>
                    </div>
                </div>
            </div>
        </div> -->



        <h1 class="display-3  mb-3">播放</h1>
        <p id="la-path" class="fw-lighter fs-4"></p>





        <!-- 列表容器 -->
        <div id="la-list-container" class="list-group"></div>

        <!-- 弹出的 “播放器” -->
        <div id="la-player" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 id="la-player-header" class="modal-title"></h5>
                        <button type="button" id="la-player-close" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div id="dplayer"></div>
                    <div id="la-img-view"></div>
                    <div id="la-player-body" class="modal-body"></div>
                </div>
            </div>
        </div>




        <script src="./js/DPlayer.min.js"></script>
</body>

</html>