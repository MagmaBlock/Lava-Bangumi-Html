<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>熔岩番剧库 - 播放列表页 | LavaAnime</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.staticfile.org/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <script src="https://cdn.staticfile.org/bootstrap/5.1.3/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap-icons/1.7.2/font/bootstrap-icons.css">
    <script src="./js/getUrlParams.js" crossorigin="anonymous"></script>
    <script src="./js/mySort.js" crossorigin="anonymous"></script>
    <link href="./style/scrollbar.css" rel="stylesheet" crossorigin="anonymous">
    </link>

    <script>
        $(document).ready(function () {



            // 熔岩云盘分享链接根目录，需要是API链接。
            animeApiUrl = "https://dav.5t5.top/api/v3/share/list/jqMFl"


            var backParams = 'year=' + getUrlParams().year + '&' + 'month=' + getUrlParams().month
            AnimePath = getUrlParams().path
            $("#goback").attr("href", "/index.html?" + backParams)

            // 填充副标题
            $("#la-path").empty().append(decodeURI(AnimePath).replace("/", ""))

            if (AnimePath == undefined) {
                console.log("地址栏不含参数！")
                $("#la-list-container").append("<div class='alert alert-warning'><span>错误：未能从地址栏取得番组信息。<a class='alert-link' href='./index.html'>返回主页</a></span></div>")
            }

            thisId = decodeURI(getUrlParams("path").path).match("\\d+$")[0]
            thisId2 = thisId.toString()
            thisId2 = thisId2.substring(0, thisId2.length - 2)

            console.log("从地址栏取得 BgmID： ", thisId, " ", thisId2)


            // 获取字典并开始生成列表
            $.ajax({
                url: "./assets/dict.json",
                success: (result) => {
                    dict = result
                    getAnimeList(dict)
                    console.log("成功取得关键词词典：", dict)
                }
            })



            // 从网盘取得文件列表
            function getAnimeList() {
                $.ajax({
                    url: animeApiUrl + AnimePath,
                    success: function (result) {
                        console.log("熔岩云盘回复：", result)
                        // 剥壳
                        if (result.code == 404) {
                            $("#la-list-container").append("<div class='alert alert-warning'><span>熔岩云盘返回了 404，您的链接可能有误或番组不存在。<br>出现此错误可能是因为此界面的链接异常。<a class='alert-link' href='./index.html'>返回主页</a></span></div>")
                            $("#loading").fadeOut()

                        }
                        objects = result.data.objects
                        if (objects.length == 0) {
                            var airDate = "(获取失败，可能是 ID 设置有误，请联系 Magma。)"
                            setTimeout(() => {
                                $("#la-list-container").append("<div class='alert alert-info'><span>熔岩云盘返回列表为空，此番组目录下尚无任何资源！<br>" + "请确认此作品已经开始连载，根据 Bangumi Wiki，本作的开始放送日期为：" + bgmInfo.date + "<br><a class='alert-link' href='./index.html'>返回主页</a></span></div>")
                                $("#loading").fadeOut()
                            }, 1500);

                        }
                        if (objects.length > 0) {
                            // 用自定义排序函数用 name 排序
                            mySort(objects, "name")
                            console.log(objects)
                            // 开始循环
                            for (var i = 0; i < objects.length; i++) {
                                // 如果这个数组描述的是一个文件类型的
                                if (objects[i].type == "file") {
                                    var fileName = objects[i].name
                                    var fileId = objects[i].id
                                    printAnimeList(fileName, fileId)
                                    // 1秒后隐藏loading
                                    setTimeout(() => {
                                        $("#loading").fadeOut()
                                    }, 1000);
                                }
                            }
                        }

                    },
                    error: (result) => {
                        $("#la-list-container").append("<div class='alert alert-warning'><span>熔岩云盘未返回值或返回错误，您的链接可能有误或熔岩云盘出现异常。<br><a class='alert-link' href='/list.html'>返回主页</a></span></div>")
                    }
                })
            }



            // 向列表追加生成的列表的函数
            function printAnimeList(fileName, fileId) {
                // 取得文件后缀名
                var fileType = fileName.replace(/.+\./, "")

                // 从字典将匹配的关键字替换为可视化标签
                tagedName = fileName
                for (i = 0; i < dict.length; i++) {
                    // 新建一个正则变量
                    fromRegExp = new RegExp(dict[i].from, 'gi')
                    // 生成的标签的html
                    toHtml = ' <span class="badge ' + dict[i].class + '">' + dict[i].to + '</span> '
                    // 进行替换
                    tagedName = tagedName.replace(fromRegExp, toHtml)
                }
                // 标签替换完成后，再空格所有的 '[' ']'
                tagedName = tagedName.replace(/\[|\]/g, " ")

                // 生成新的html
                var rawNameByfileId = fileId + '-name'
                var newListObj = "<button style='opacity:0.85' id='" + fileId + "' type='button' data-bs-toggle='modal' data-bs-target='#la-player' class='la-list-anime list-group-item list-group-item-action'>" + tagedName + '<br><div id="' + rawNameByfileId + '" class="text-secondary fw-lighter" style="font-size: 12px">' + fileName + "</div></button>"
                // 追加html
                $("#la-list-container").append(newListObj)
                // 再给每个列表项增加点击时事件
                $("#" + fileId).click(function () {
                    // 加载中提示
                    $("#la-player-header").empty().append("正在等待熔岩云盘返回播放链接...")
                    $("#la-player-body").empty().append("<p>请稍等，这段文字通常活不过 1 秒...<br>但是若持续看到此提示可能是熔岩云盘出现异常或您的网络连接不稳定！</p>")
                    // 生成当前文件的变量
                    thisName = $('#' + rawNameByfileId)[0].innerText
                    thisId = $(this)[0].id
                    $.ajax({
                        url: "https://api.5t5.top/api/v1/object/url/" + thisId,
                        success: function (result) {

                            var mp4HelpMessage = "<p class='mb-0'><p class='text-secondary' style='font-size: 14px'>黑屏 / 无法播放？可能是浏览器不支持 H.265 编码，<br>请使用下方的按钮调用外部播放器。</p></p>"
                            var mkvHelpMessage = "<div class='mb-1'>浏览器不支持当前格式 (MKV)，<br>请使用外部播放器来播放。<div class='text-secondary' style='font-size: 14px'>这是由于大部分均无法支持 H.265 格式及 MKV 格式内封的字幕。需要调用您设备上的播放软件播放。<br>同时也可以复制链接后使用弹弹 Play 播放效果更佳。</div></div>"
                            var mkvPlayerBtn = '<a id="mkvPlayerBtn" class="btn btn-sm btn-outline-primary mb-4 mt-0">强制用浏览器打开</a>'
                            var otherPlayers = '<div class="display-6 mb-3">外部播放器</div><div class="row row-cols-4"><a class="text-decoration-none text-secondary" href="potplayer://' + result.url + '"><img class="img-fluid mx-auto d-block" style="width: 80%;" src="./assets/PotPlayer.svg" alt="PotPlayer"/><div class="text-center" style="font-size: 12px;">PotPlayer</div></a><a class="text-decoration-none text-secondary" href="vlc://' + result.url + '"><img class="img-fluid mx-auto d-block" style="width: 80%;" src="./assets/vlc.svg" alt="VLC"/><div class="text-center" style="font-size: 12px;">VLC</div></a><a class="text-decoration-none text-secondary" href="href="iina://weblink?url=' + result.url + '"><img class="img-fluid mx-auto d-block" style="width: 80%;" src="./assets/iina.svg" alt="IINA"/><div class="text-center" style="font-size: 12px;">IINA</div></a><a class="text-decoration-none text-secondary" href="' + result.url + '"><img class="img-fluid mx-auto d-block" style="width: 80%;" src="./assets/link.svg" alt="IINA"/><div class="text-center" style="font-size: 12px;">复制链接</div></a></div>'

                            $("#la-player-header").empty().append(thisName)

                            const dp = new DPlayer({
                                container: document.getElementById('dplayer'),
                                video: {
                                    url: result.url,
                                    screenshot: true,
                                    autoplay: true
                                },
                            });

                            if (fileType == 'mp4') {
                                $("#la-player-body").empty().append(mp4HelpMessage + otherPlayers)
                            }
                            if (fileType == 'mkv') {
                                dp.destroy()
                                $("#la-player-body").empty().append(mkvHelpMessage + mkvPlayerBtn + otherPlayers)
                                $("#mkvPlayerBtn").click(() => {
                                    const dp = new DPlayer({
                                        container: document.getElementById('dplayer'),
                                        video: {
                                            url: result.url,
                                            screenshot: true,
                                            autoplay: true
                                        },
                                    });
                                }
                                )
                            }
                            if (fileType == 'torrent') {
                                dp.destroy()
                                $("#la-player-body").empty().append("您打开了一个种子文件，若有需要，可点击下方按钮下载。" + "<br>" + rawBtn)
                            }

                            if (fileType == 'zip') {
                                dp.destroy()
                                $("#la-player-body").empty().append("您打开了一个压缩包，若有需要，可点击下方按钮下载。" + "<br>" + rawBtn)
                            }
                            if (fileType == '7z') {
                                dp.destroy()
                                $("#la-player-body").empty().append("您打开了一个压缩包，若有需要，可点击下方按钮下载。" + "<br>" + rawBtn)
                            }
                            if (fileType == 'png') {
                                dp.destroy()
                                $("#la-img-view").empty().append('<img class="img-fluid " src="' + result.url + '">')
                                $("#la-player-body").empty().append("您打开了一张图片。")
                            }
                            if (fileType == 'jpg') {
                                dp.destroy()
                                $("#la-img-view").empty().append('<img class="img-fluid " src="' + result.url + '">')
                                $("#la-player-body").empty().append("您打开了一张图片。")
                            }
                            if (fileType == 'webp') {
                                dp.destroy()
                                $("#la-img-view").empty().append('<img class="img-fluid " src="' + result.url + '">')
                                $("#la-player-body").empty().append("您打开了一张图片。")
                            }
                            if (fileType == 'txt') {
                                dp.destroy()
                                $("#la-player-body").empty().append("您打开了一个文本文档，若有需要，可点击下方按钮下载。" + "<br>" + rawBtn)


                            }



                            // 为播放器增加关闭时销毁事件
                            var lavaAnimeModalPlayer = document.getElementById('la-player')
                            lavaAnimeModalPlayer.addEventListener('hide.bs.modal', function (event) {
                                dp.destroy()
                                $("#la-img-view").empty()
                            })

                        }
                    })

                })
            }

            // 获取 Bangumi API 然后填充数据
            $.ajax({
                url: "https://bgm-api.5t5.top/v0/subjects/" + thisId,
                success: result => {
                    bgmInfo = result
                    var backgroundUrl = bgmInfo.images.large.replace("lain.bgm.tv", "anime-img.5t5.top") + '/bg'
                    console.log('成功从番组计划API取得数据', result)
                    console.log(bgmInfo.images.large.replace("lain.bgm.tv", "anime-img.5t5.top") + '/bg')
                    $("#bg").css("background-image", "url(" + backgroundUrl + ")")
                    $("#bangumi").attr("href","https://bgm.tv/subject/" + thisId)
                }
            })

            // 获取 Agefans 数据, 数据来自 https://github.com/czy0729/Bangumi-Static/
            $.ajax({
                url: "https://raw.githubusercontent.com/czy0729/Bangumi-Static/master/data/agefans/anime.min.json",
                success: result => {
                    var agefansData = JSON.parse(result)
                    for (var i = 0; i < agefansData.length; i++){
                        var agefansId = ''
                        if (agefansData[i].id == thisId){
                            console.log('解析到当前 Bangumi ID 对应的 Agefans 数据：',agefansData[i])
                            $("#agefans").attr("href","https://www.agefans.vip/detail/" + agefansData[i].a)
                            agefansId = agefansData[i].a
                        }
                        if (agefansId = ''){
                            $("#agefans").empty().append('<i class="bi bi-slash-circle"></i> 暂未在 Agefans 找到此番剧')
                        }
                    }
                }
            })

        })
    </script>
</head>

<body id="bg" style="background-attachment: fixed; background-position: center; background-size: cover;">
    <nav class="navbar navbar-light bg-light shadow fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" id="goback">
                <i class="bi bi-chevron-left mx-1"></i>
                <span>返回索引页</span>
            </a>

            <div id="loading" class="spinner-border position-absolute top-0 end-0 m-2"></div>
        </div>
    </nav>
    <div class="container mt-5">


        <br>
        <!-- 
        <div class="card mb-3" style="max-width: 540px;">
            <div class="row g-0">
                <div style="max-height: 300px;" id="la-poster" class="col-md-4">
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <h5 class="card-title">Card title</h5>
                        <p class="card-text">This is a wider card with supporting text below as a natural lead-in to
                            additional content. This content is a little bit longer.</p>
                        <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>
                    </div>
                </div>
            </div>
        </div> -->


        <div class="my-2 list-group" style="opacity: 85%;">
            <div class="list-group-item list-group-item-action">
                <h1 class="display-3">播放列表</h1>
                <div id="la-path" class="fw-lighter fs-6"></div>
                <a id="agefans" target="_blank" class="fw-lighter fs-6 text-decoration-none"><i class="bi bi-link-45deg"></i> 去 Agefans 观看</a> <a href="https://github.com/czy0729/Bangumi-Static" class="text-decoration-none text-secondary" target="_blank" style="font-size: 12px;">(API By czy0729)</a><br>
                <a id="bangumi" target="_blank" class="fw-lighter fs-6 text-decoration-none"><i class="bi bi-link-45deg"></i> 去 番组计划 查看详情</a>
            </div>
        </div>



        <!-- 列表容器 -->
        <div id="la-list-container" class="list-group mb-3"></div>

        <!-- 弹出的 “播放器” -->
        <div id="la-player" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="text-break modal-header">
                        <h5 id="la-player-header" class="modal-title"></h5>
                        <button type="button" id="la-player-close" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div id="dplayer"></div>
                    <div id="la-img-view"></div>
                    <div id="la-player-body" class="modal-body"></div>
                </div>
            </div>
        </div>

        <!-- <div class="row row-cols-4">
            <a class="text-decoration-none text-secondary" href="#">
                <img class="img-fluid mx-auto d-block" style="width: 80%;" src="./assets/PotPlayer.svg" alt="PotPlayer"/>
                <div class="text-center" style="font-size: 12px;">PotPlayer</div>
            </a>
            <a class="text-decoration-none text-secondary" href="#">
                <img class="img-fluid mx-auto d-block" style="width: 80%;" src="./assets/vlc.svg" alt="VLC"/>
                <div class="text-center" style="font-size: 12px;">VLC</div>
            </a>
            <a class="text-decoration-none text-secondary" href="#">
                <img class="img-fluid mx-auto d-block" style="width: 80%;" src="./assets/iina.svg" alt="IINA"/>
                <div class="text-center" style="font-size: 12px;">IINA</div>
            </a>
            <a class="text-decoration-none text-secondary" href="#">
                <img class="img-fluid mx-auto d-block" style="width: 80%;" src="./assets/link.svg" alt="IINA"/>
                <div class="text-center" style="font-size: 12px;">复制链接</div>
            </a>
        </div> -->



        <script src="./js/DPlayer.min.js"></script>
        <img src="https://www.bfcounter.vip/generatepic?userid=ce1d3f3b-ce67-4319-8222-e751f8262b2e" alt="Page Counter"
            class="visually-hidden">
        <span class="visually-hidden">
            <script type="text/javascript"
                src="https://v1.cnzz.com/z_stat.php?id=1280746775&web_id=1280746775"></script>
        </span>
</body>

</html>