<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>熔岩番剧库 - 番剧索引 | LavaAnime</title>
    <!-- <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.staticfile.org/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <script src="https://cdn.staticfile.org/bootstrap/5.1.3/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <style>
        ::-webkit-scrollbar {
            width: 10px;
            height: 6px;
            background-color: rgba(0, 0, 0, 0);
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            border: 0px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-track {
            background-color: transparent;
        }
    </style>
    <script>
        $(document).ready(function () {


            // 界面加载后，隐藏加载中图标
            $("#loading").hide()

            // 界面加载后，获取年代列表
            $.ajax({
                url: "https://dav.5t5.top/api/v3/share/list/jqMFl/",
                success: function (result) {
                    // 解壳
                    var objects = result.data.objects
                    // 新建一个数组用于排序
                    var yearSorter = new Array()
                    // 将得到的每个文件夹的名字写进数组
                    for (var i = 0; i < objects.length; i++) {
                        yearSorter[i] = objects[i].name
                    }
                    // 把数组按字母排序再倒序
                    var yearList = yearSorter.sort().reverse()
                    console.log(yearList)
                    // for 循环写入文档
                    for (var i = 0; i < yearList.length; i++) {
                        // 删去文件夹名字里的“年”
                        yearList[i] = yearList[i].toString();
                        yearList[i] = yearList[i].substring(0, yearList[i].length - 1)
                        //输出html
                        $("<input type=\"radio\" name=\"year\" class=\"btn-check btn-year\" id=\"" + yearList[i] + "\"><label style=\"min-width: max-content;\" class=\"btn btn-outline-primary\" for=\"" + yearList[i] + "\">" + yearList[i] + "</label></button>").appendTo("#years");

                    }
                    // 为每个按钮追加点击时触发的函数
                    $(".btn-year").click(function () {
                        // 找出被点击的那个按钮勾
                        var clickedYear = $('input:radio[name="year"]:checked')[0].id
                        // 调用函数
                        getMonthList(clickedYear)

                    })
                }
            })



            function getMonthList(year) {
                $.ajax({
                    beforeSend: function () {
                        $("#months").empty()
                    },
                    url: "https://dav.5t5.top/api/v3/share/list/jqMFl/" + year + "年",
                    success: function (result) {
                        // 解壳
                        var objects = result.data.objects
                        console.log(objects)
                        // 新建一个数组用于排序
                        var monthSorter = new Array()
                        // 将得到的每个文件夹的名字写进数组
                        for (var i = 0; i < objects.length; i++) {
                            monthSorter[i] = objects[i].name
                        }
                        // 把数组按字母排序再倒序
                        var monthList = monthSorter.sort()
                        console.log(monthList)

                        for (var i = 0; i < monthList.length; i++) {
                            //输出html
                            $("<input type=\"radio\" name=\"month\" class=\"btn-check btn-month\"  id=\"" + monthList[i] + "\"><label style=\"min-width: max-content;\" class=\"btn btn-outline-primary\" for=\"" + monthList[i] + "\">" + monthList[i] + "</label></button>").appendTo("#months");
                        }
                        // 为每个按钮追加点击函数
                        $(".btn-month").click(function () {
                            // 定义月变量
                            var clickedMonth = $('input:radio[name="month"]:checked')[0].id
                            getAnimeList(year, clickedMonth)
                        })


                    }

                })
            }




            function getAnimeList(year, month) {
                $("#loading").fadeIn()
                // 清除容器
                $("#posters").empty()
                // 从云盘取得相应季度番剧列表
                $.get("https://dav.5t5.top/api/v3/share/list/jqMFl/" + year + "年/" + month,
                    // 取回来之后执行的函数
                    function (data, status) {
                        // 剥去 CR Api 的壳
                        var fanList = data.data.objects;
                        console.log(fanList)

                        // 循环总文件夹次
                        for (var i = 0; i < fanList.length; i++) {
                            // 匹配此文件夹末尾的 BgmId
                            let thisId = fanList[i].name.match("\\d+$")
                            let animeName = fanList[i].name.replace(fanList[i].name.match("\\d+$"),"")
                            let animeUrl = "/anime.html?path=/" + year + "年/" + month + "/" + fanList[i].name
                            // 如果匹配失败
                            if (thisId == null) {
                                console.log("来自熔岩云盘的文件夹 \"" + fanList[i].name + "\" 不是一个合法的番剧库番组！")
                            }

                            // 匹配成功，开始获取主视觉图并生成卡片
                            else {
                                // 生成此番组的 ID 和 API用短 ID
                                var thisId2 = thisId.toString();
                                thisId2 = thisId2.substring(0, thisId2.length - 2)

                                // 请求 API
                                $.ajax({
                                    url: "https://cdn.jsdelivr.net/gh/czy0729/Bangumi-Subject@master/data/" + thisId2 + "/" + thisId + ".json",
                                    success: function (result) {
                                        // 更改主视觉图的画质
                                        posterUrl = result.image.replace("/m/", "/l/")
                                        PrintAnimeCard("posters", posterUrl, animeName, animeUrl)
                                    },
                                    error: function (xhr) {
                                        // 请求 Bangumi 官方 API
                                        console.log("番组\"" + thisId + "\"Bangumi CDN 命中失败，正在请求原站...   下方是错误原因")
                                        console.log(xhr)
                                        $.ajax({
                                            url: "https://api.bgm.tv/subject/" + thisId,
                                            success: function (result) {
                                                console.log("Bangumi 官方 API 返回数据: ")
                                                console.log(result)
                                                posterUrl = result.images.large
                                                PrintAnimeCard("posters", posterUrl, animeName, animeUrl)
                                            }
                                        })
                                    }
                                })
                            }
                        }
                        setTimeout(() => {
                            $("#loading").fadeOut()
                        }, 2000);
                    }
                );
            }
            // 向指定容器内填充番剧卡片的函数
            // 需要传递容器的ID、主视觉图的ID、名称、播放链接到函数内
            // 函数会自动为容器添加class
            function PrintAnimeCard(containerId, posterUrl, animeName, animeUrl) {
                $("#" + containerId).addClass("row row-cols-auto mx-2")
                var newAnimeCard = "<div class=\"col-4 col-sm-3 col-lg-2 mb-2\"><a href=\"" + animeUrl + "\" class=\"text-decoration-none text-black\"><img class=\"rounded mb-1 img-fluid shadow\" src=\"" + posterUrl + "\"><br><p style=\"font-size: small;\">" + animeName + "</p></a></div>"
                $("#" + containerId).append(newAnimeCard);
            }







        });
    </script>
</head>

<body>
    <nav class="navbar navbar-light bg-light shadow fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="https://s-sh-2164-assets.oss.dogecdn.com/LavaDrive/icons/LavaCloud.svg" alt="" width="30"
                    height="30" class="d-inline-block align-bottom">
                熔岩番剧库 LavaAnime
            </a>
            <div id="loading" class="spinner-border text-secondary"></div>
        </div>
    </nav>



    <div class="container mt-5">
        <br>
        <div class="mx-3 mt-2">
            <h1 class="display-3">番剧索引</h1>
            <h5 class="lead ">年代</h5>
            <div class="btn-group-sm mb-2 btn-group overflow-scroll" id="years"
                style="padding-left: 1px; max-width: 100%;">
            </div>
            <h5 class="lead">季度 / 类型</h5>
            <div class="btn-group-sm mb-2 btn-group overflow-scroll" id="months"
                style="padding-left: 1px; max-width: 100%; height: 37px;">
            </div>
        </div>

        <div id="posters">
            <!-- class="row row-cols-auto mx-2" -->

            <!-- <div class="col-4 col-sm-3 col-lg-2 mb-2">
                <a href="#" class="text-decoration-none text-black">
                    <img class="rounded mb-1 img-fluid shadow "
                        src="http://lain.bgm.tv/pic/cover/c/85/45/333349_nnTfr.jpg"><br>
                    <p style="font-size: small;">贾希女王不会放弃</p>
                </a>
            </div> -->

        </div>


    </div>
</body>

</html>